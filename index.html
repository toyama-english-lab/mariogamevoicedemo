<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Game Mario Demo</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; margin: 0; padding: 50px; }
#object-card { font-size: 2rem; margin: 20px; min-height: 50px; }
#status { margin-top: 20px; font-size: 1.2rem; color: #333; }
button { margin: 10px 5px; padding: 10px 20px; font-size: 1rem; border: none; border-radius: 8px; background-color: #007bff; color: white; cursor: pointer; }
button:hover { background-color: #0056b3; }
#progress-container { width: 80%; background-color: #ddd; margin: 20px auto; border-radius: 10px; height: 20px; }
#progress-bar { width: 0%; height: 100%; background-color: #4caf50; border-radius: 10px; transition: width 0.3s; }
#scoreboard { font-size: 1.5rem; margin-top: 20px; }
#video-container { margin-top: 20px; }
#lives { font-size: 1.5rem; color: red; }
</style>
</head>
<body>
<h1>Voice Game Demo - Mario Speedrun</h1>
<div>
<button onclick="setMode(true)">Strict Mode</button>
<button onclick="setMode(false)">Not So Strict Mode</button>
</div>
<div id="object-card"></div>
<div>
<button onclick="skipObject()">Skip</button>
</div>
<div id="status">Choose a mode to start</div>
<div id="progress-container"><div id="progress-bar"></div></div>
<div id="scoreboard">Score: 0</div>
<div id="lives">Lives: 3</div>
<div id="video-container">
<video id="marioVideo" width="480" height="270" preload="auto">
<source src="speedrun.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>
</div>
<script>
const objects = ['Apple','Book','Clock','Pen','Chair','Cup','Phone','Bag','Lamp','Key','Table','Shoe','Bottle','Notebook','Hat','Glasses','Watch','Wallet','Paper','Door'];
let randomizedObjects = shuffleArray(objects.slice());
let currentIndex = 0;
let skipped = [];
let score = 0;
let multiplier = 1;
let strictMode = true;
let lives = 3;
let recognition;
let startTime;
let currentSegment = 0;

const video = document.getElementById('marioVideo');
const segments = Array.from({length:20}, (_,i)=>({start: i* (video.duration/20), end: (i+1)*(video.duration/20)})); // approximate timing, will fix on metadata load

video.addEventListener('loadedmetadata', ()=>{
  for(let i=0;i<segments.length;i++){
    segments[i].start = i*(video.duration/20);
    segments[i].end = (i+1)*(video.duration/20);
  }
});

function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()* (i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

function setMode(strict){
  strictMode = strict;
  document.getElementById('status').textContent = `Mode set to ${strict ? 'Strict' : 'Not So Strict'}! Speak the word...`;
  currentIndex = 0;
  randomizedObjects = shuffleArray(objects.slice());
  skipped = [];
  score = 0;
  multiplier = 1;
  lives = 3;
  currentSegment = 0;
  startTime = Date.now();
  updateCard();
  updateScore();
  updateLives();
  startRecognition();
}

function updateCard(){
  if(currentIndex>=randomizedObjects.length){
    document.getElementById('object-card').textContent='Finished!';
    document.getElementById('status').textContent='Round complete!';
    document.getElementById('progress-bar').style.width='100%';
    reviewSkipped();
    alert(`Final Score: ${Math.round(score)}`);
    return;
  }
  document.getElementById('object-card').textContent = randomizedObjects[currentIndex];
  document.getElementById('progress-bar').style.width = `${(currentIndex/randomizedObjects.length)*100}%`;
}

function startRecognition(){
  if(!('webkitSpeechRecognition' in window)){ alert("Browser does not support speech recognition."); return; }
  recognition = new webkitSpeechRecognition();
  recognition.lang="en-US";
  recognition.interimResults=false;
  recognition.maxAlternatives=1;
  recognition.start();
  document.getElementById('status').textContent="Listening...";

  recognition.onresult=(event)=>{
    let spoken = event.results[0][0].transcript.trim().toLowerCase();
    const expected = randomizedObjects[currentIndex].toLowerCase();
    let correct = strictMode ? spoken===expected : spoken.includes(expected);

    if(correct){
      const timeTaken = (Date.now()-startTime)/1000;
      const speedMultiplier = Math.max(1,10/timeTaken);
      score += 10*multiplier*speedMultiplier;
      multiplier++;
      document.getElementById('status').textContent = `✅ Correct! You said '${spoken}'`;
      playNextSegment();
      currentIndex++;
      startTime=Date.now();
      updateCard();
      updateScore();
      if(currentIndex<randomizedObjects.length) startRecognition();
    } else {
      multiplier=1;
      lives--;
      updateLives();
      document.getElementById('status').textContent=`❌ You said '${spoken}'. Multiplier reset.`;
      if(lives<=0){ gameOver(); return; }
      startRecognition();
    }
  };

  recognition.onerror=(event)=>{ document.getElementById('status').textContent="Error: "+event.error; };
  recognition.onend=()=>{ if(currentIndex<randomizedObjects.length && lives>0) recognition.start(); };
}

function playNextSegment(){
  if(currentSegment>=segments.length) return;
  video.currentTime = segments[currentSegment].start;
  video.play();
  const stopHandler = ()=>{
    if(video.currentTime>=segments[currentSegment].end){
      video.pause();
      video.removeEventListener('timeupdate',stopHandler);
    }
  };
  video.addEventListener('timeupdate',stopHandler);
  currentSegment++;
}

function skipObject(){
  skipped.push(randomizedObjects[currentIndex]);
  score-=5;
  multiplier=1;
  lives--; updateLives();
  if(lives<=0){ gameOver(); return; }
  currentIndex++;
  updateCard();
  updateScore();
}

function reviewSkipped(){
  if(skipped.length===0) return;
  document.getElementById('status').textContent='Review skipped items';
  skipped.forEach(word=>{ const utter=new SpeechSynthesisUtterance(word); window.speechSynthesis.speak(utter); });
}

function updateScore(){ document.getElementById('scoreboard').textContent=`Score: ${Math.round(score)}`; }
function updateLives(){ document.getElementById('lives').textContent=`Lives: ${lives}`; }
function gameOver(){ alert('Game Over!'); video.pause(); }

updateCard();
</script>
</body>
</html>
